<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>codex-mcp Admin</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 1rem 2rem; max-width: 900px; }
    h1 { font-size: 1.25rem; }
    h2 { font-size: 1rem; margin-top: 1.5rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.4rem 0.6rem; text-align: left; }
    th { background: #f0f0f0; }
    input, button { margin: 0.2rem; }
    textarea { width: 100%; min-height: 120px; font-family: monospace; font-size: 12px; }
    .error { color: #c00; }
    .success { color: #080; }
  </style>
</head>
<body>
  <h1>codex-mcp Admin</h1>

  <h2>目录列表</h2>
  <table id="dirTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>名称</th>
        <th>路径</th>
        <th>语言</th>
        <th>角色</th>
        <th>启用</th>
        <th>Git 自动更新</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p>
    <input id="newName" placeholder="名称" size="10">
    <input id="newPath" placeholder="绝对路径" size="40">
    <input id="newLang" placeholder="语言" size="8">
    <input id="newRole" placeholder="角色" size="8">
    <button id="btnAdd">添加目录</button>
  </p>
  <p id="dirMsg" class="error"></p>

  <h2>忽略规则（gitignore 格式）</h2>
  <p>每行一条规则，保存后热重载，无需重启。</p>
  <textarea id="ignoreContent" placeholder="# 示例&#10;.git&#10;node_modules&#10;*.log"></textarea>
  <p>
    <button id="btnLoadIgnore">加载</button>
    <button id="btnSaveIgnore">保存</button>
    <span id="ignoreMsg" class="error"></span>
  </p>

  <script>
    const API = '';
    function dirList() {
      return fetch(API + '/api/directories').then(r => r.json());
    }
    function dirAdd(name, path, language, role) {
      return fetch(API + '/api/directories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, path, language, role })
      });
    }
    function dirDelete(id) {
      return fetch(API + '/api/directories/' + id, { method: 'DELETE' });
    }
    function dirSetEnabled(id, enabled) {
      return fetch(API + '/api/directories/' + id + '/enabled', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      });
    }
    function dirSetGitInterval(id, intervalSec) {
      return fetch(API + '/api/directories/' + id + '/git', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ auto_update_interval_sec: intervalSec })
      });
    }
    function dirGitPull(id) {
      return fetch(API + '/api/directories/' + id + '/git/pull', { method: 'POST' });
    }
    function ignoreGet() {
      return fetch(API + '/api/ignore-file').then(r => r.text());
    }
    function ignorePut(content) {
      return fetch(API + '/api/ignore-file', {
        method: 'PUT',
        body: content
      });
    }

    const GIT_INTERVALS = [
      [0, '关闭'],
      [300, '5 分钟'],
      [600, '10 分钟'],
      [1800, '30 分钟'],
      [3600, '1 小时']
    ];
    function formatGitLastUpdated(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        return d.toLocaleString('zh-CN');
      } catch (e) { return iso; }
    }
    function renderDirs(list) {
      const tbody = document.querySelector('#dirTable tbody');
      tbody.innerHTML = list.map(d => {
        const intervalVal = d.git_auto_update_interval_sec || 0;
        const options = GIT_INTERVALS.map(([val, label]) =>
          `<option value="${val}" ${val === intervalVal ? 'selected' : ''}>${label}</option>`).join('');
        return `
        <tr>
          <td>${d.id}</td>
          <td>${escapeHtml(d.name)}</td>
          <td><code>${escapeHtml(d.path)}</code></td>
          <td>${escapeHtml(d.language)}</td>
          <td>${escapeHtml(d.role)}</td>
          <td>${d.enabled ? '是' : '否'}</td>
          <td>
            <select data-id="${d.id}" data-action="git-interval" style="margin-right:0.5rem">${options}</select>
            <span data-id="${d.id}" data-action="git-last">${formatGitLastUpdated(d.git_last_updated_at)}</span>
            <button data-id="${d.id}" data-action="git-pull" style="margin-left:0.5rem">手动更新</button>
          </td>
          <td>
            <button data-id="${d.id}" data-action="toggle">${d.enabled ? '禁用' : '启用'}</button>
            <button data-id="${d.id}" data-action="delete">删除</button>
          </td>
        </tr>
      `}).join('');
      tbody.querySelectorAll('[data-action=toggle]').forEach(btn => {
        btn.onclick = () => {
          const id = parseInt(btn.dataset.id, 10);
          const row = btn.closest('tr');
          const enabled = row.cells[5].textContent === '是';
          dirSetEnabled(id, !enabled).then(() => refreshDirs()).catch(e => showDirMsg(e.message));
        };
      });
      tbody.querySelectorAll('[data-action=delete]').forEach(btn => {
        btn.onclick = () => {
          if (!confirm('确定删除？')) return;
          dirDelete(btn.dataset.id).then(() => refreshDirs()).catch(e => showDirMsg(e.message));
        };
      });
      tbody.querySelectorAll('[data-action=git-interval]').forEach(sel => {
        sel.onchange = () => {
          const id = parseInt(sel.dataset.id, 10);
          const val = parseInt(sel.value, 10);
          dirSetGitInterval(id, val).then(r => { if (!r.ok) throw new Error(r.statusText); refreshDirs(); }).catch(e => showDirMsg('设置失败: ' + e.message));
        };
      });
      tbody.querySelectorAll('[data-action=git-pull]').forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.id;
          btn.disabled = true;
          dirGitPull(id).then(r => {
            if (!r.ok) throw new Error(r.statusText);
            return refreshDirs();
          }).catch(e => showDirMsg('拉取失败: ' + e.message)).finally(() => { btn.disabled = false; });
        };
      });
    }
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    function showDirMsg(msg) {
      document.getElementById('dirMsg').textContent = msg;
    }
    function refreshDirs() {
      document.getElementById('dirMsg').textContent = '';
      dirList().then(renderDirs).catch(e => showDirMsg('加载失败: ' + e.message));
    }

    document.getElementById('btnAdd').onclick = () => {
      const name = document.getElementById('newName').value.trim();
      const path = document.getElementById('newPath').value.trim();
      const lang = document.getElementById('newLang').value.trim();
      const role = document.getElementById('newRole').value.trim();
      if (!name || !path) { showDirMsg('名称和路径必填'); return; }
      dirAdd(name, path, lang, role)
        .then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); })
        .then(() => { refreshDirs(); showDirMsg('已添加'); document.getElementById('newName').value = ''; document.getElementById('newPath').value = ''; })
        .catch(e => showDirMsg('添加失败: ' + e.message));
    };

    document.getElementById('btnLoadIgnore').onclick = () => {
      document.getElementById('ignoreMsg').textContent = '';
      ignoreGet().then(t => { document.getElementById('ignoreContent').value = t; }).catch(e => { document.getElementById('ignoreMsg').textContent = '加载失败: ' + e.message; });
    };
    document.getElementById('btnSaveIgnore').onclick = () => {
      const msgEl = document.getElementById('ignoreMsg');
      msgEl.textContent = '';
      ignorePut(document.getElementById('ignoreContent').value)
        .then(r => { if (!r.ok) throw new Error(r.statusText); msgEl.textContent = '已保存，热重载生效'; msgEl.className = 'success'; })
        .catch(e => { msgEl.textContent = '保存失败: ' + e.message; msgEl.className = 'error'; });
    };

    refreshDirs();
    ignoreGet().then(t => { document.getElementById('ignoreContent').value = t || ''; }).catch(() => {});
  </script>
</body>
</html>
